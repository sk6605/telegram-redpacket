<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>æŠ¢çº¢åŒ…</title>
<style>
  body{background:linear-gradient(180deg,#b30000,#7a0000);margin:0;height:100vh;display:flex;align-items:center;justify-content:center;font-family:"Microsoft YaHei",sans-serif;color:#fff}
  .envelope{width:240px;height:320px;background:#d40000;border-radius:12px;position:relative;box-shadow:0 0 30px rgba(0,0,0,.5)}
  .top{height:60%;background:#b00000;border-bottom-left-radius:50%;border-bottom-right-radius:50%}
  .circle{position:absolute;bottom:60px;left:50%;transform:translateX(-50%);width:100px;height:100px;background:gold;border-radius:50%;display:flex;align-items:center;justify-content:center;color:red;font-size:28px;font-weight:bold;cursor:pointer}
  .msg{margin-top:20px;font-size:18px;text-align:center;min-height:24px}
  .score-fly{position:absolute;font-size:24px;font-weight:bold;color:gold;text-shadow:0 0 5px #fff,0 0 10px #ff0;animation:flyUp 1s forwards}
  @keyframes flyUp{0%{transform:translateY(0);opacity:1}100%{transform:translateY(-120px) scale(1.2);opacity:0}}
</style>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
  <div class="envelope">
    <div class="top"></div>
    <div class="circle" id="grabBtn">æŠ¢</div>
  </div>
  <div class="msg" id="msg">ç‚¹å‡»â€œæŠ¢â€çœ‹çœ‹ä½ çš„æ‰‹æ°”å§ï¼</div>

<script>
const API_BASE = "https://your-domain-or-ngrok"; // <- æ”¹æˆä½ çš„åç«¯åœ°å€ (ä¾‹ https://roseanna-loamless-adolfo.ngrok-free.dev æˆ– https://bao.wtf)
const tg = window.Telegram?.WebApp;
tg?.expand();

const params = new URLSearchParams(window.location.search);
const gid = params.get("gid");
const game_id = params.get("game_id");

const uid = (tg?.initDataUnsafe?.user?.id && String(tg.initDataUnsafe.user.id)) || ("guest_" + Math.random().toString(36).slice(2,10));
const username = tg?.initDataUnsafe?.user?.username || `æ¸¸å®¢${Math.floor(Math.random()*1000)}`;

const grabBtn = document.getElementById("grabBtn");
const msg = document.getElementById("msg");

function showScoreFly(display){
  const el = document.createElement("div");
  el.className = "score-fly";
  el.innerText = `ğŸ‰ ${display} ğŸ‰`;
  document.body.appendChild(el);
  el.style.left = (window.innerWidth/2 - 50) + "px";
  el.style.top = (window.innerHeight/2 - 50) + "px";
  setTimeout(()=>el.remove(),1000);
}

grabBtn.addEventListener("click", async () => {
  grabBtn.style.display = "none";
  msg.innerText = "æ­£åœ¨è¿æ¥æœåŠ¡å™¨...";

  if (!gid || !game_id) {
    msg.innerHTML = "ğŸš« å‚æ•°ç¼ºå¤±ï¼ˆgid æˆ– game_idï¼‰ï¼Œè¯·ä»ç¾¤é‡Œæ‰“å¼€é“¾æ¥ã€‚";
    grabBtn.style.display = "block";
    return;
  }

  try {
    const res = await fetch(`${API_BASE}/grab?gid=${encodeURIComponent(gid)}&game_id=${encodeURIComponent(game_id)}&uid=${encodeURIComponent(uid)}`, {
      method: "POST"
    });

    const text = await res.text();
    console.log("Raw response:", text);
    let data;
    try { data = JSON.parse(text); } catch(e){ msg.innerText = "è¿”å›é JSON å†…å®¹"; grabBtn.style.display = "block"; return; }

    console.log("Parsed:", data);

    if (!data.ok) {
      msg.innerHTML = `ğŸš« ${data.reason || "æŠ¢çº¢åŒ…å¤±è´¥"}`;
      grabBtn.style.display = "block";
      return;
    }

    const points = Number(data.points ?? 0);
    msg.innerHTML = `ğŸ‰ ${username} æŠ¢åˆ°äº† <b>${points}</b> ç‚¹ï¼`;
    showScoreFly(points);

    // å‘é€åˆ° Telegram containerï¼ˆå¦‚æœæ˜¯é€šè¿‡ WebApp æ‰“å¼€ï¼‰
    try { tg?.sendData(JSON.stringify({ uid, username, points, game_id })); } catch(e) { /* ignore */ }
    setTimeout(()=>tg?.close?.(), 2000);
  } catch (err) {
    console.error("fetch error", err);
    msg.innerText = "âŒ ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åå†è¯•";
    grabBtn.style.display = "block";
  }
});
</script>
</body>
</html>